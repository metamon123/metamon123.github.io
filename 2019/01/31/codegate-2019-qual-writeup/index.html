<!DOCTYPE html>
<html lang=KR>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="Codegate Qual Writeup (mic check, 20000, PyProt3ct) with KAIST GoN이번 대회는 문제의 카테고리가 없었던 덕분에(?) 맨날 잡던 Web이 아닌 문제를 풀 수 있었다.   1. MIC check1234Let the hacking begins ~ Decode it : 9P&amp;amp;;gFD,5.BOPCdBl7Q+">
<meta name="keywords" content="ctf,writeup">
<meta property="og:type" content="article">
<meta property="og:title" content="codegate-2019-qual-writeup">
<meta property="og:url" content="http://yoursite.com/2019/01/31/codegate-2019-qual-writeup/index.html">
<meta property="og:site_name" content="metamon chronicle">
<meta property="og:description" content="Codegate Qual Writeup (mic check, 20000, PyProt3ct) with KAIST GoN이번 대회는 문제의 카테고리가 없었던 덕분에(?) 맨날 잡던 Web이 아닌 문제를 풀 수 있었다.   1. MIC check1234Let the hacking begins ~ Decode it : 9P&amp;amp;;gFD,5.BOPCdBl7Q+">
<meta property="og:locale" content="KR">
<meta property="og:updated_time" content="2019-01-31T12:45:01.988Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="codegate-2019-qual-writeup">
<meta name="twitter:description" content="Codegate Qual Writeup (mic check, 20000, PyProt3ct) with KAIST GoN이번 대회는 문제의 카테고리가 없었던 덕분에(?) 맨날 잡던 Web이 아닌 문제를 풀 수 있었다.   1. MIC check1234Let the hacking begins ~ Decode it : 9P&amp;amp;;gFD,5.BOPCdBl7Q+">
    
    
        
          
              <link rel="shortcut icon" href="../../../../images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="../../../../images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="../../../../images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>codegate-2019-qual-writeup</title>
    <!-- styles -->
    <link rel="stylesheet" href="../../../../css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="../../../../css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="../../../../index.html">Home</a></li>
         
          <li><a href="../../../../about/">About</a></li>
         
          <li><a href="../../../../archives/">Writing</a></li>
         
          <li><a href="../../../../categories/">categories</a></li>
         
          <li><a href="../../../../tags/">tags</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="../../13/python-internal-0/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <!--<li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>-->
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <!--<span id="i-share" class="info" style="display:none;">Share post</span>-->
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/01/31/codegate-2019-qual-writeup/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/01/31/codegate-2019-qual-writeup/&text=codegate-2019-qual-writeup"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/01/31/codegate-2019-qual-writeup/&title=codegate-2019-qual-writeup"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/01/31/codegate-2019-qual-writeup/&is_video=false&description=codegate-2019-qual-writeup"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=codegate-2019-qual-writeup&body=Check out this article: http://yoursite.com/2019/01/31/codegate-2019-qual-writeup/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/01/31/codegate-2019-qual-writeup/&title=codegate-2019-qual-writeup"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/01/31/codegate-2019-qual-writeup/&title=codegate-2019-qual-writeup"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/01/31/codegate-2019-qual-writeup/&title=codegate-2019-qual-writeup"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/01/31/codegate-2019-qual-writeup/&title=codegate-2019-qual-writeup"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/01/31/codegate-2019-qual-writeup/&name=codegate-2019-qual-writeup&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Codegate-Qual-Writeup-mic-check-20000-PyProt3ct-with-KAIST-GoN"><span class="toc-number">1.</span> <span class="toc-text">Codegate Qual Writeup (mic check, 20000, PyProt3ct) with KAIST GoN</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-MIC-check"><span class="toc-number">1.1.</span> <span class="toc-text">1. MIC check</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-20000"><span class="toc-number">1.2.</span> <span class="toc-text">2. 20000</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-PyProt3ct"><span class="toc-number">1.3.</span> <span class="toc-text">3. PyProt3ct</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Deobfuscate-of-play-py"><span class="toc-number">1.3.1.</span> <span class="toc-text">1) Deobfuscate of play.py</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Analyze-VM-code-play-py"><span class="toc-number">1.3.2.</span> <span class="toc-text">2) Analyze VM code (play.py)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#instruction-format"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">instruction format</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#memory-structure"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">memory structure</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#instructions-thanks-to-ironore-for-help"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">instructions (thanks to ironore for help)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Disassemble-custom-binary-code-and-analyze-it-by-pruning-unnecessary-routines-and-dynamic-debugging"><span class="toc-number">1.3.3.</span> <span class="toc-text">3) Disassemble custom binary (./code) and analyze it by pruning unnecessary routines and dynamic debugging</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#a-len-flag-8-일-때-gt-flag-를-본격적으로-읽어오는-일-없이-fail"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">a) len(flag) != 8 일 때 =&gt; flag 를 본격적으로 읽어오는 일 없이 fail</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#b-len-flag-8-일-때-gt-len-flag-와-8번의-copy-array-nth-elem-가-모두-사용"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">b) len(flag) == 8 일 때 =&gt; len(flag) 와 8번의 copy_array_nth_elem 가 모두 사용</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Conclusion-Actual-routine-of-code-binary-where-user-input-is-used"><span class="toc-number">1.3.4.</span> <span class="toc-text">Conclusion : Actual routine of ./code binary where user input is used</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        codegate-2019-qual-writeup
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">metamon chronicle</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-01-31T12:18:44.000Z" itemprop="datePublished">2019-01-31</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="../../../../categories/hacking/">hacking</a> › <a class="category-link" href="../../../../categories/hacking/writeup/">writeup</a> › <a class="category-link" href="../../../../categories/hacking/writeup/codegate-2019-qual/">codegate-2019-qual</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="../../../../tags/ctf/">ctf</a>, <a class="tag-link" href="../../../../tags/writeup/">writeup</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="Codegate-Qual-Writeup-mic-check-20000-PyProt3ct-with-KAIST-GoN"><a href="#Codegate-Qual-Writeup-mic-check-20000-PyProt3ct-with-KAIST-GoN" class="headerlink" title="Codegate Qual Writeup (mic check, 20000, PyProt3ct) with KAIST GoN"></a>Codegate Qual Writeup (mic check, 20000, PyProt3ct) with KAIST GoN</h1><p>이번 대회는 문제의 카테고리가 없었던 덕분에(?) 맨날 잡던 Web이 아닌 문제를 풀 수 있었다.  </p>
<h2 id="1-MIC-check"><a href="#1-MIC-check" class="headerlink" title="1. MIC check"></a>1. MIC check</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Let the hacking begins ~ </span><br><span class="line"></span><br><span class="line">Decode it : </span><br><span class="line">9P&amp;;gFD,5.BOPCdBl7Q+@V&apos;1dDK?qL</span><br></pre></td></tr></table></figure>
<p>뭔가를 encode 하라고 하는데, 우리가 흔히 볼 수 있는 base64 라고 하기에는 &amp;;,.@’? 등 해당되지 않는 글자들이 많았다. 그래서 혹시나 하고 encoding 된 문자열을 구성하는 문자 종류가 더 많은 encoding 이 있나 찾아보니, 여기에 Ascii85 가 사용되었음을 알 수 있었다.</p>
<p><a href="https://cryptii.com/pipes/ascii85-encoding" target="_blank" rel="noopener">https://cryptii.com/pipes/ascii85-encoding</a> 에서 <code>9P&amp;;gFD,5.BOPCdBl7Q+@V&#39;1dDK?qL</code>을 decoding 해보니<br><code>Let the hacking begins ~</code>이 나왔다.</p>
<p><strong>Flag : Let the hacking begins ~</strong>  <del>신기하게도 설명의 첫 줄이 답이었다!</del></p>
<h2 id="2-20000"><a href="#2-20000" class="headerlink" title="2. 20000"></a>2. 20000</h2><p>20000 이라는 바이너리와 함께, 무려 20000 개 (ㄴOoOㄱ!) 의 .so 파일들이 주어졌다.</p>
<p>20000 바이너리 자체에는 특별한 기능이 없었었다. 이 친구는 [1, 20000] 사이의 int 를 입력 받고, 입력 받은 값에 해당하는 .so 파일 (123이 입력되었으면 lib_123.so) 에 정의된 <code>test</code>함수를 실행시키는 기능을 한다.</p>
<p>그럼 이제 20000개의 lib.so 들을 확인해보자..!</p>
<p>우선, lib_1.so 는 다음과 같았다.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">__<span class="function">int64 <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+0h] [rbp-40h]</span></span><br><span class="line">  __int16 v2; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;buf, <span class="number">0</span>, <span class="number">0x30</span>uLL);</span><br><span class="line">  v2 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"This is lib_1 file."</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"How do you find vulnerable file?"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x32</span>uLL);</span><br><span class="line">  system(<span class="string">"exit"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *__<span class="function">fastcall <span class="title">filter2</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strchr</span>(a1, <span class="string">'v'</span>) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strchr</span>(a1, <span class="string">'m'</span>) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strchr</span>(a1, <span class="string">'p'</span>) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strchr</span>(a1, <span class="string">'d'</span>) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strchr</span>(a1, <span class="string">'n'</span>) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(a1, <span class="string">"bin"</span>) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(a1, <span class="string">"sh"</span>) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(a1, <span class="string">"bash"</span>) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strchr</span>(a1, <span class="string">'f'</span>) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strchr</span>(a1, <span class="string">'l'</span>) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  result = <span class="built_in">strchr</span>(a1, <span class="string">'g'</span>);</span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>여기서의 test 함수에서는 취약점이 없어보였고, filter2 는 아직 어디서 불리는지도 모르는 상황이었다. 그래서 정말로 20000 개의 .so 에 대해서 fuzzer 를 돌려야 할지를 망설이면서 lib_2.so 를 봤는데, 이 친구도 lib_1.so 와 사실 상 같았다. 거의 유일하게 다른 부분이라곤 <code>&quot;This is lib_1 file.&quot; &lt;=&gt; &quot;This is lib_2 file.&quot;</code>정도였고, 이쯤되니 .so 파일들을 하나하나 살펴보는 것은 무의미하다고 생각했다.</p>
<p>그래서 한번 20000 개의 .so 파일들의 크기를 확인해봤는데, 놀랍게도 이들은 6224B, 6200B, 6192B, 6176B 의 4가지 크기로 분류될 수 있었다! “왠 떡이냐~” 하면서 각 크기별로 하나씩 .so 파일들을 살펴보니 다음과 같았다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// Type 1: size = 6224B</span><br><span class="line">test:</span><br><span class="line">	유저로부터 0x32 만큼의 입력(ex. &quot;20000&quot;)을 받고, 이를 Type 2 에 해당하는 .so 의 filter1 과 Type 3 에 해당하는 .so 의 filter2 함수를 통해 검사한 뒤, system(&quot;ls \&quot;입력(ex. 20000)\&quot;&quot;) 실행.</span><br><span class="line"></span><br><span class="line">// Type 2: size = 6200B</span><br><span class="line">test: 무의미</span><br><span class="line">filter2: vmpdnflg, &quot;bin&quot;, &quot;sh&quot;, &quot;bash&quot; 필터링</span><br><span class="line"></span><br><span class="line">// Type 3: size = 6192B</span><br><span class="line">test: 무의미</span><br><span class="line">filter1: ;*|&amp;$`&gt;&lt;r 필터링</span><br><span class="line"></span><br><span class="line">// Type 4: size = 6176B</span><br><span class="line">test: 무의미</span><br></pre></td></tr></table></figure>
<p>주어진 filter1, filter2 를 통과해서 shell 을 획득할 방법을 모르겠어서, 혹시나 다른 .so 파일 중에서 이상한 filter1, filter2 를 가진 파일이 있는지를 확인해보기로 했다.</p>
<ul>
<li>하나하나 filter1, filter2 부분의 symbol 의 주소를 획득해서, 해당 함수 루틴의 byte code 가 다른 것을 찾는다.<ul>
<li>pwntools 의 ELF 함수를 쓰려고 했는데, Type 2, Type 3 의 .so 파일 10000개에 대해서 돌릴려니 ELF 함수가 무거워서 너무 오래 걸렸다.</li>
</ul>
</li>
<li>단순 diff 를 통해 byte code 가 크게 다른 것을 찾는다.<ul>
<li><code>xxd lib_1.so lib_1.hex; xxd lib_2.so lib_2.hex; diff lib_1.hex lib_2.hex</code></li>
<li>filter1 에서는 lib_4323.so, filter2 에서는 lib_11804.so 가 독보적으로 diff 의 결과가 컸고, 얘네만 보니 각각 filter1 에서는 |, filter2 에서는 “bin”, “sh” 가 필터링에서 제외가 되어있었다.</li>
</ul>
</li>
</ul>
<p>이제 lib_4323.so 와 lib_11804.so 에서 filter1, filter2 를 받아오는 Type 1 so 파일을 <code>strings lib_5.so | grep &quot;4323&quot; | grep &quot;11804&quot;</code> 을 통해서 확인해보았더니, 공교롭게도 lib_17394.so 에서 이 둘을 동시에 사용하고 있었고, 심지어는 system 에 들어가는 인자가 다르기까지 했다.</p>
<p><code>sprintf(&amp;s, &quot;%s 2 &gt; /dev/null&quot;, &amp;buf); system(&amp;s);</code></p>
<p>이제 문제는 ;*&amp;`$&gt;&lt;rvmpdnflg 와 “bash” 없이 shell 을 획득하는 것으로 바뀌었고, 이는 다음과 같이 쉽게 우회할 수 있다.</p>
<ul>
<li><code>sh #</code></li>
</ul>
<p><strong>Flag : Are_y0u_A_h@cker_in_real-word?</strong></p>
<h2 id="3-PyProt3ct"><a href="#3-PyProt3ct" class="headerlink" title="3. PyProt3ct"></a>3. PyProt3ct</h2><p>문제에 대한 설명에 들어가기 앞서, 평소에 리버싱을 안 하던 사람으로서 이 문제를 7시간 넘게 붙잡고서 (그렇게 어려운 문제가 아니었음에도) 느낀 것들을 잠시 정리해보자!</p>
<ul>
<li>regex의 기본적인 사용법, 이를 통한 deobfuscating (다만… 어려운 문제에서는 regex만으로는 턱도 없을 것이다 ㅠㅠ)</li>
<li>vim 에서 어셈블리 코드에서 특정 변수들을 추적할 때 <code>/asdf\|qwer\|zxcv</code> 이렇게 하면 3개 다 하이라이트 되서 편하다.</li>
<li>virtual machine 코드를 분석하는 순서, 스타일 (instruction fetch/decode하는 부분부터 보면서, memory의 구조, pointer, object type 차곡차곡 구성해가기)</li>
<li>디스어셈블리를 짜는 것은 생각보다 별 것이 아니다!</li>
<li>리버싱은 정직해서는 안된다. Reasonable한 게싱, 센스, 그리고 융통성이 필수.</li>
</ul>
<hr>
<p>문제에서는 세 개의 파일을 줬다.</p>
<ul>
<li><p>code</p>
<ul>
<li>custom binary</li>
</ul>
</li>
<li><p>chal.py</p>
<ul>
<li>code 와 user input (flag) 를 받아서 play.O0O0O0O00OO0O0O0O(code, flag) 의 결과에 따라 :) 나 :( 를 출력</li>
</ul>
</li>
<li><p>play.py</p>
<ul>
<li><p>변수들이 [O0]{17} 로 obfuscated 되어있는 python 코드</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">O0O0OOO00OO00O000</span><span class="params">(OOOO0OOOO000OO000)</span>:</span></span><br><span class="line">    O00OOOOOO000OOO00=<span class="number">2001</span></span><br><span class="line">    OOO0OOOOOOO0O00O0=<span class="number">2002</span></span><br><span class="line">    O0O00000000OO0OO0=OOOO0OOOO000OO000[O00OOOOOO000OOO00]</span><br><span class="line">    O0O00000000OO0OO0=O0O00000000OO0OO0.decode(<span class="string">"utf-8"</span>)</span><br><span class="line">    OOOOO0OOO0OOO0O0O=OOOO0OOOO000OO000[OOO0OOOOOOO0O00O0]</span><br><span class="line">    OOOOO0OOO0OOO0O0O=OOOOO0OOO0OOO0O0O.decode(<span class="string">"utf-8"</span>)</span><br><span class="line">    OOOOO0OOO0OOO0O0O=int(OOOOO0OOO0OOO0O0O)</span><br><span class="line">    OOOO0OOOO000OO000[O0O00000000OO0OO0]=OOOOO0OOO0OOO0O0O</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">O0O000000OO0OOO0O</span><span class="params">(OO000OO00000OO0OO)</span>:</span></span><br><span class="line">    OOOO000O000OO0O0O=<span class="number">2001</span></span><br><span class="line">    OO0OO0OOOOOOO0OO0=<span class="number">2002</span></span><br><span class="line">    O0O000O000OOO0OO0=OO000OO00000OO0OO[OOOO000O000OO0O0O]</span><br><span class="line">    O0O000O000OOO0OO0=O0O000O000OOO0OO0.decode(<span class="string">"utf-8"</span>)</span><br><span class="line">    O0O0OO00OOO0O0OO0=OO000OO00000OO0OO[OO0OO0OOOOOOO0OO0]</span><br><span class="line">    O0O0OO00OOO0O0OO0=O0O0OO00OOO0O0OO0.decode(<span class="string">"utf-8"</span>)</span><br><span class="line">    O0O0OO00OOO0O0OO0=OO000OO00000OO0OO[O0O0OO00OOO0O0OO0]</span><br><span class="line">    OO000OO00000OO0OO[O0O000O000OOO0OO0]=O0O0OO00OOO0O0OO0</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 이하 생략</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h3 id="1-Deobfuscate-of-play-py"><a href="#1-Deobfuscate-of-play-py" class="headerlink" title="1) Deobfuscate of play.py"></a>1) Deobfuscate of play.py</h3><p>play.py 를 분석하기 위해, 다음과 같은 순서로 난독화를 풀어보았다.</p>
<ul>
<li>정규식 패턴 [0O]{17} 로 되어있는 변수들을 전부 <code>x1x, x2x, ...</code>와 같이 변경</li>
<li>함수 선언 부분을 정규식으로 읽어서 함수 이름들을 <code>f1f, f2f, ...</code>와 같이 변경</li>
<li><code>x1x=x2x, x3x&gt;x4x</code>와 같이 연산자 가 양옆 토큰과 붙어있는 것이 너무 불편하기 때문에 양옆에 공백을 추가</li>
<li><code>x1x, x2x, f1f, f2f</code>를 <code>x1, f1</code>과 같이 변경</li>
</ul>
<p>deobfuscate 의 결과, play.py 는 다음과 같았다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f0</span><span class="params">(arg0)</span>:</span></span><br><span class="line">    x74 = <span class="number">2001</span></span><br><span class="line">    x194 = <span class="number">2002</span></span><br><span class="line">    x87 = arg0[x74]</span><br><span class="line">    x87 = x87.decode(<span class="string">"utf-8"</span>)</span><br><span class="line">    x25 = arg0[x194]</span><br><span class="line">    x25 = x25.decode(<span class="string">"utf-8"</span>)</span><br><span class="line">    x25 = int(x25)</span><br><span class="line">    arg0[x87] = x25</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 중간 생략</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f19</span><span class="params">(arg0)</span>:</span></span><br><span class="line">    x122 = <span class="number">2001</span></span><br><span class="line">    x20 = <span class="number">1000</span></span><br><span class="line">    x76 = arg0[x122]</span><br><span class="line">    x76 = x76.decode(<span class="string">"utf-8"</span>)</span><br><span class="line">    x76 = int(x76)</span><br><span class="line">    arg0[x20] = x76</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f20</span><span class="params">(arg0 ,arg1)</span>:</span></span><br><span class="line">    table = dict()</span><br><span class="line">    x169 = <span class="number">1000</span></span><br><span class="line">    x62 = <span class="number">1001</span></span><br><span class="line">    x147 = <span class="number">2001</span></span><br><span class="line">    x170 = <span class="number">2002</span></span><br><span class="line">    x114 = <span class="number">2003</span></span><br><span class="line">    x42 = <span class="number">2004</span></span><br><span class="line">    x84 = <span class="number">0</span></span><br><span class="line">    x137 = <span class="number">1</span></span><br><span class="line">    x37 = <span class="number">2</span></span><br><span class="line">    x72 = <span class="number">3</span></span><br><span class="line">    x112 = <span class="number">4</span></span><br><span class="line">    x165 = <span class="number">5</span></span><br><span class="line">    table[x169] = <span class="number">0</span></span><br><span class="line">    table[x62] = <span class="number">0</span></span><br><span class="line">    table[<span class="string">"flag"</span>] = arg1</span><br><span class="line">    x97 = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> x97 == <span class="number">0</span>:</span><br><span class="line">        x45 = table[x169]</span><br><span class="line">        x68 = arg0[x45]</span><br><span class="line">        x45 = x45 + x137</span><br><span class="line">        x36 = arg0[x45]</span><br><span class="line">        x45 = x45 + x137</span><br><span class="line">        <span class="keyword">if</span> x84 &lt; x36:</span><br><span class="line">            x69 = arg0[x45]</span><br><span class="line">            x45 = x45 + x137</span><br><span class="line">            x67 = x45</span><br><span class="line">            x21 = x45 + x69</span><br><span class="line">            x152 = arg0[x67:x21]</span><br><span class="line">            table[x147] = x152</span><br><span class="line">            x45 = x45 + x69</span><br><span class="line">        <span class="keyword">if</span> x137 &lt; x36:</span><br><span class="line">            x149 = arg0[x45]</span><br><span class="line">            x45 = x45 + x137</span><br><span class="line">            x117 = x45</span><br><span class="line">            x135 = x45 + x149</span><br><span class="line">            x178 = arg0[x117:x135]</span><br><span class="line">            table[x170] = x178</span><br><span class="line">            x45 = x45 + x149</span><br><span class="line">        <span class="keyword">if</span> x37 &lt; x36:</span><br><span class="line">            x93 = arg0[x45]</span><br><span class="line">            x45 = x45 + x137</span><br><span class="line">            x61 = x45</span><br><span class="line">            x166 = x45 + x93</span><br><span class="line">            x182 = arg0[x61:x166]</span><br><span class="line">            table[x114] = x182</span><br><span class="line">            x45 = x45 + x93</span><br><span class="line">        <span class="keyword">if</span> x72 &lt; x36:</span><br><span class="line">            x50 = arg0[x45]</span><br><span class="line">            x45 = x45 + x137</span><br><span class="line">            x35 = x45</span><br><span class="line">            x28 = x45 + x50</span><br><span class="line">            x185 = arg0[x35:x28]</span><br><span class="line">            table[x42] = x185</span><br><span class="line">            x45 = x45 + x50</span><br><span class="line">        table[x169] = x45</span><br><span class="line">        <span class="keyword">if</span> x68 == <span class="number">0</span>:</span><br><span class="line">            f0(table)</span><br><span class="line">        <span class="keyword">elif</span> x68 == <span class="number">2</span>:</span><br><span class="line">            f4(table)</span><br><span class="line">        <span class="keyword">elif</span> x68 == <span class="number">8</span>:</span><br><span class="line">            f18(table)</span><br><span class="line">        <span class="keyword">elif</span> x68 == <span class="number">11</span>:</span><br><span class="line">            f19(table)</span><br><span class="line">        <span class="keyword">elif</span> x68 == <span class="number">34</span>:</span><br><span class="line">            f2(table)</span><br><span class="line">        <span class="keyword">elif</span> x68 == <span class="number">41</span>:</span><br><span class="line">            f11(table)</span><br><span class="line">        <span class="keyword">elif</span> x68 == <span class="number">44</span>:</span><br><span class="line">            f12(table)</span><br><span class="line">        <span class="keyword">elif</span> x68 == <span class="number">49</span>:</span><br><span class="line">            f17(table)</span><br><span class="line">        <span class="keyword">elif</span> x68 == <span class="number">72</span>:</span><br><span class="line">            f14(table)</span><br><span class="line">        <span class="keyword">elif</span> x68 == <span class="number">74</span>:</span><br><span class="line">            f13(table)</span><br><span class="line">        <span class="keyword">elif</span> x68 == <span class="number">81</span>:</span><br><span class="line">            f15(table)</span><br><span class="line">        <span class="keyword">elif</span> x68 == <span class="number">82</span>:</span><br><span class="line">            f1(table)</span><br><span class="line">        <span class="keyword">elif</span> x68 == <span class="number">91</span>:</span><br><span class="line">            f16(table)</span><br><span class="line">        <span class="keyword">elif</span> x68 == <span class="number">99</span>:</span><br><span class="line">            f3(table)</span><br><span class="line">        <span class="keyword">elif</span> x68 == <span class="number">102</span>:</span><br><span class="line">            f5(table)</span><br><span class="line">        <span class="keyword">elif</span> x68 == <span class="number">111</span>:</span><br><span class="line">            f8(table)</span><br><span class="line">        <span class="keyword">elif</span> x68 == <span class="number">131</span>:</span><br><span class="line">            f7(table)</span><br><span class="line">        <span class="keyword">elif</span> x68 == <span class="number">151</span>:</span><br><span class="line">            f10(table)</span><br><span class="line">        <span class="keyword">elif</span> x68 == <span class="number">171</span>:</span><br><span class="line">            f9(table)</span><br><span class="line">        <span class="keyword">elif</span> x68 == <span class="number">186</span>:</span><br><span class="line">            f6(table)</span><br><span class="line">        x45 = table[x169]</span><br><span class="line">        <span class="keyword">if</span> x68 == <span class="number">74</span>:</span><br><span class="line">            x97 = <span class="number">1</span></span><br><span class="line">    x59 = table[x62]</span><br><span class="line">    <span class="keyword">return</span> x59</span><br></pre></td></tr></table></figure>
<h3 id="2-Analyze-VM-code-play-py"><a href="#2-Analyze-VM-code-play-py" class="headerlink" title="2) Analyze VM code (play.py)"></a>2) Analyze VM code (play.py)</h3><p><code>f20</code>을 보니 custom vm 에서 instruction 을 fetch, decode 하고 있는 것을 확인할 수 있고, <code>f0 ~ f19</code>는 각 instruction 의 동작임을 알 수 있었다. 이제 이를 고려해서 <code>f20, f0 ~ f19</code>순으로 vm 의 동작을 분석해보았다.</p>
<h4 id="instruction-format"><a href="#instruction-format" class="headerlink" title="instruction format"></a>instruction format</h4><p><code>instruction = opcode oparg_count ([arglen ([byte]{arglen})?]{oparg_count})?</code></p>
<h4 id="memory-structure"><a href="#memory-structure" class="headerlink" title="memory structure"></a>memory structure</h4><p>이 vm 에서의 메모리는 크게 두 종류의 item 을 가지는 dictionary table 이다.</p>
<ul>
<li>int 를 key 로 하는 register storage<ul>
<li>가능한 key 로는 1000, 1001, 2001, 2002, 2003, 2004 가 있다.</li>
<li>각 key 에 해당하는 value 가 무슨 역할을 하는 지는 아래의 표를 참조</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th>key</th>
<th>content (purpose)</th>
</tr>
</thead>
<tbody>
<tr>
<td>1000</td>
<td>return address (mostly int, but object is theoretically possible)</td>
</tr>
<tr>
<td>1001</td>
<td>return value (mostly int, but object is theoretically possible)</td>
</tr>
<tr>
<td>2001, 2002, 2003, 2004</td>
<td>instruction argument (== oparg) (always byte array)</td>
</tr>
</tbody>
</table>
<ul>
<li><p>string 을 key 로 하는 general storage</p>
<ul>
<li><p>이 vm 에서 포인터(주소)의 역할을 하는 것은 string key 이다.</p>
</li>
<li><p>string key 가 매핑하는 value 들이 object type 을 가진다고 하면, 이는 다음과 같이 정의된다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">object ::= bytearray | int | string (| all python objects)</span><br></pre></td></tr></table></figure>
<p>all python objects 가 object 에 포함되는 것은 call_fn_<em> instruction 에서 임의의 string 으로 eval 한 결과를 vm memory 에 넣을 수 있어서인데, 나중에 code binary 를 disassemble 해보면 call_fn_</em> instruction 은 len(flag) 에서만 사용되기 때문에 all python objects 는 무시해도 무방하다.</p>
</li>
</ul>
</li>
</ul>
<h4 id="instructions-thanks-to-ironore-for-help"><a href="#instructions-thanks-to-ironore-for-help" class="headerlink" title="instructions (thanks to ironore for help)"></a>instructions (thanks to ironore for help)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">f0 : store_int</span><br><span class="line">2001 : str1, 2002 : (val2) str2 (decimal string)</span><br><span class="line">&gt;&gt; table[str1] = int(val)</span><br><span class="line"></span><br><span class="line">f1 : move</span><br><span class="line">2001 : str1, 2002 : str2</span><br><span class="line">&gt;&gt; table[str1] = table[str2]</span><br><span class="line"></span><br><span class="line">f2 : copy_array_nth_elem</span><br><span class="line">2001 : str1</span><br><span class="line">2002 : (arr2) str2 (pointing to array ::= bytearray || string)</span><br><span class="line">2003 : (idx) str3 (decimal =&gt; val3 || non-decimal =&gt; pointing to int)</span><br><span class="line">&gt;&gt; table[str1] = bytearray[idx] (storing int)</span><br><span class="line">OR</span><br><span class="line">&gt;&gt; table[str1] = string[idx] (storing string)</span><br><span class="line"></span><br><span class="line">f3 : copy_array_range</span><br><span class="line">2001 : str1, 2002 : str2</span><br><span class="line">2003 : (start idx) str3 (decimal =&gt; val3 || non-decimal =&gt; pointing to int)</span><br><span class="line">2004 : (end idx) str4 (decimal =&gt; val4 || non-decimal =&gt; pointing to int)</span><br><span class="line">&gt;&gt; table[str1] = str2[val3:val4]</span><br><span class="line"></span><br><span class="line">f4 : assign_bytearray_nth_elem</span><br><span class="line">2001 : str1 (pointing to bytearray)</span><br><span class="line">2002 : (src idx) str2 (decimal =&gt; val2 || non-decimal =&gt; pointing to int)</span><br><span class="line">2003 : (val3) str3 (decimal =&gt; val3 || non-decimal =&gt; pointing to int)</span><br><span class="line">  At first glance, string and bytearray seem possible,</span><br><span class="line">  but it is revealed that str1 cannot point to string (since it&apos;s immutable) </span><br><span class="line">&gt;&gt; bytearr1 = table[str1]</span><br><span class="line">&gt;&gt; bytearr1[val2] = val3</span><br><span class="line"></span><br><span class="line">f5 : add_obj</span><br><span class="line">2001 : str1</span><br><span class="line">2002 : (obj2) str2 (decimal =&gt; int obj2 || non-decimal =&gt; obj2 (bytearray, int, string))</span><br><span class="line">2003 : (obj3) str3 (decimal =&gt; int obj3 || non-decimal =&gt; obj3 (bytearray, int, string))</span><br><span class="line">&gt;&gt; table[str1] = obj2 + obj3 (obj2 and obj3 should have same type (int, int / ba, ba / string, string))</span><br><span class="line"></span><br><span class="line">f6 : xor_int</span><br><span class="line">2001 : str1</span><br><span class="line">2002 : (int) str2 (dec =&gt; int || non-dec =&gt; pointing to int)</span><br><span class="line">2003 : (int) str3 (dec =&gt; int || non-dec =&gt; pointing to int)</span><br><span class="line">&gt;&gt; table[str1] = val2 ^ val3 (since python ^ is allowed only for integer object, val2 &amp; val3 should be int)</span><br><span class="line"></span><br><span class="line">f7 : and_int</span><br><span class="line">&gt;&gt; table[str1] = val2 &amp; val3</span><br><span class="line"></span><br><span class="line">f8 : or_int</span><br><span class="line">&gt;&gt; table[str1] = val2 | val3</span><br><span class="line"></span><br><span class="line">f9 : rshift_int</span><br><span class="line">&gt;&gt; table[str1] = val2 &gt;&gt; val3</span><br><span class="line"></span><br><span class="line">f10 : lshift_int</span><br><span class="line">&gt;&gt; table[str1] = val2 &lt;&lt; val3</span><br><span class="line"></span><br><span class="line">f11 : call_fn_arg1</span><br><span class="line">2001 : (expression that returns function object) str1</span><br><span class="line">  It&apos;s weird! It retrieve function object using eval(str1)</span><br><span class="line">2002 : (function argument obj2) str2 (dec =&gt; int obj2 || non-dec =&gt; obj2 (bytearray || int || string))</span><br><span class="line">&gt;&gt; table[1001] (return value) = (fn := eval(str1))(obj2)</span><br><span class="line">&gt;&gt; (simply, return value = fn(obj2))</span><br><span class="line"></span><br><span class="line">f12 : call_fn_arg0</span><br><span class="line">2001 : (expression that returns function object) str1</span><br><span class="line">  It&apos;s weird! It retrieve function object using eval(str1)</span><br><span class="line">&gt;&gt; return value = fn()</span><br><span class="line"></span><br><span class="line">f13 : set_retvalue</span><br><span class="line">2001 : (return object) str1 (dec =&gt; int obj1 || non-dec =&gt; pointing to obj1)</span><br><span class="line">&gt;&gt; return value = obj1</span><br><span class="line"></span><br><span class="line">f14 : get_retvalue</span><br><span class="line">2001 : str</span><br><span class="line">&gt;&gt; table[str1] = return value</span><br><span class="line"></span><br><span class="line">f15 : jmp_e</span><br><span class="line">2001 : (jmp_addr) val1 (bytearray with decimal string)</span><br><span class="line">2002 : (obj2) str2 (decimal =&gt; int obj2 || non-decimal =&gt; obj2 (bytearray, int, string))</span><br><span class="line">2003 : (obj3) str3 (decimal =&gt; int obj3 || non-decimal =&gt; obj3 (bytearray, int, string))</span><br><span class="line">&gt;&gt; table[1000] = val1 if obj2 == obj3</span><br><span class="line"></span><br><span class="line">f16 : jmp_ne</span><br><span class="line">2001 : (jmp_addr) val1 (bytearray with decimal string)</span><br><span class="line">2002 : (obj2) str2 (decimal =&gt; int obj2 || non-decimal =&gt; obj2 (bytearray, int, string))</span><br><span class="line">2003 : (obj3) str3 (decimal =&gt; int obj3 || non-decimal =&gt; obj3 (bytearray, int, string))</span><br><span class="line">&gt;&gt; table[1000] = val1 if obj2 != obj3</span><br><span class="line"></span><br><span class="line">f17 : jmp_l</span><br><span class="line">2001 : (jmp_addr) val1 (bytearray with decimal string)</span><br><span class="line">2002 : (obj2) str2 (decimal =&gt; int obj2 || non-decimal =&gt; obj2 (bytearray, int, string))</span><br><span class="line">2003 : (obj3) str3 (decimal =&gt; int obj3 || non-decimal =&gt; obj3 (bytearray, int, string))</span><br><span class="line">&gt;&gt; table[1000] = val1 if obj2 &lt; obj3 (obj2 and obj3 should have same type (int, int / ba, ba / string, string))</span><br><span class="line"></span><br><span class="line">f18 : jmp_ge</span><br><span class="line">2001 : (jmp_addr) val1 (bytearray with decimal string)</span><br><span class="line">2002 : (obj2) str2 (decimal =&gt; int obj2 || non-decimal =&gt; obj2 (bytearray, int, string))</span><br><span class="line">2003 : (obj3) str3 (decimal =&gt; int obj3 || non-decimal =&gt; obj3 (bytearray, int, string))</span><br><span class="line">&gt;&gt; table[1000] = val1 if obj2 &gt;= obj3 (obj2 and obj3 should have same type (int, int / ba, ba / string, string))</span><br><span class="line"></span><br><span class="line">f19 : jmp</span><br><span class="line">2001 : (jmp_addr) val (bytearray with decimal string)</span><br><span class="line">&gt;&gt; table[1000] = val</span><br></pre></td></tr></table></figure>
<h3 id="3-Disassemble-custom-binary-code-and-analyze-it-by-pruning-unnecessary-routines-and-dynamic-debugging"><a href="#3-Disassemble-custom-binary-code-and-analyze-it-by-pruning-unnecessary-routines-and-dynamic-debugging" class="headerlink" title="3) Disassemble custom binary (./code) and analyze it by pruning unnecessary routines and dynamic debugging"></a>3) Disassemble custom binary (./code) and analyze it by pruning unnecessary routines and dynamic debugging</h3><p>앞에서 vm 코드는 분석을 했으니 이제 disassembler 를 자서 binary 를 분석해야 하는데… 같은 팀의 <code>ironore</code>님이 disassembler 를 짜줬다! 1차적으로 disassemble + deobfuscate instruction name 만 해주니, 다음과 같았다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// disassemble + deobfuscate instruction name</span><br><span class="line">0 : store_int OOOOO0OOO0O0OOOO00O0O00OOO0OO0O0000O0OOO000000OOO0OO00OOOO00O0OO0000OOOO0OOO000 215232</span><br><span class="line">89 : store_int OOO0OOOO000OOO000O000OO00O0O0OO00OOOOO0O0000O000O0000OO00O0O00OO0O0OO0OOO000000OOOOOOOOOOO000 1934246</span><br><span class="line">193 : store_int OOOO00O00O0OO0O0OOO0OOOOOOO000O0O00OO0O0000OOOOOOO000O0OOO0000OOO00O00000OOO000OOOOO0 3907144</span><br><span class="line">289 : xor_int OOO00OO0OOOO0O0O00O00OO0O0OO0O0O0O0OOOOOO0OO000O00O0O0O0O0OO00OO00OOOO0000OO00OO00OOOOO0OO00O0O0OOO0OO00O0O000000O00 OOO0OOOO000OOO000O000OO00O0O0OO00OOOOO0O0000O000O0000OO00O0O00OO0O0OO0OOO000000OOOOOOOOOOO000 OOOO00O00O0OO0O0OOO0OOOOOOO000O0O00OO0O0000OOOOOOO000O0OOO0000OOO00O00000OOO000OOOOO0</span><br><span class="line">588 : add_obj OOO0OOO00O0000O0OO000O00OOOOO00OO0OOOO00OOOO000OOOO0OO00O0O0O00O0O00000000OOOOOOOO OOOOO0OOO0O0OOOO00O0O00OOO0OO0O0000O0OOO000000OOO0OO00OOOO00O0OO0000OOOO0OOO000 OOO00OO0OOOO0O0O00O00OO0O0OO0O0O0O0OOOOOO0OO000O00O0O0O0O0OO00OO00OOOO0000OO00OO00OOOOO0OO00O0O0OOO0OO00O0O000000O00</span><br><span class="line">870 : store_int O00OO00OO0O0OOOOO0O000OO0O00O0OOOO00OOO000O 30984</span><br><span class="line">922 : store_int O00000OO00OOO00000O000O0OOOO0O00O0000O00OO0O 7126</span><br><span class="line">974 : store_int OO0O0OOOO0O0OO00OOO0000OOOO0O0000OO000O00000000OOO00O00OO0OOO0000OOOOO0 22475</span><br><span class="line">1054 : add_obj O0OO0O000O00OOO000OO0OO0OOO0OO00OO0000OOO0O0O0O0O00 O00000OO00OOO00000O000O0OOOO0O00O0000O00OO0O OO0O0OOOO0O0OO00OOO0000OOOO0O0000OO000O00000000OOO00O00OO0OOO0000OOOOO0</span><br><span class="line">1225 : store_int O00O0O0O0O000OO0O00O000O0OOOO0OO000OO0O0O0OO0O0OO00O0OO0O00OO00O0O000OOO00OO0000OO0OOO0000OO00OO0OO0OOO0000O00O00OOOOOO 33325</span><br><span class="line">1353 : xor_int OOO0OOOO0O000O0O00000OO0OOO000OOOO O0OO0O000O00OOO000OO0OO0OOO0OO00OO0000OOO0O0O0O0O00 O00O0O0O0O000OO0O00O000O0OOOO0OO000OO0O0O0OO0O0OO00O0OO0O00OO00O0O000OOO00OO0000OO0OOO0000OO00OO0OO0OOO0000O00O00OOOOOO</span><br><span class="line">1562 : xor_int O00O0O0OOO0OO0O0OOOOOO00O0O00O00OO000O00OO0O00O0O0000OO0000O0O0OOOO00O0OOOO0O0OO0O00O0000O0OO000OOOOO0O00000OO000000000 O00OO00OO0O0OOOOO0O000OO0O00O0OOOO00OOO000O OOO0OOOO0O000O0O00000OO0OOO000OOOO</span><br><span class="line">1763 : store_int OO0000OO0O00OOOO00000O0OOOOOOOOOOO0OOO0OOOO0O 38229</span><br><span class="line">1817 : store_int OOOO0O0O0OOO0O0O0O0O00O0O00OOOOOOO0OO0 19486</span><br><span class="line">...</span><br><span class="line">(총 4000줄 정도)</span><br></pre></td></tr></table></figure>
<p>instruction name 이 아닌 0OO00OO0O0… 들을 deobfuscate 하고 싶었지만, 만약에 이 binary 에 <code>copy_array_range + call_fn_*</code>의 instruction 조합이 있다면 <code>OO0000OO0O00OOOO00000O0OOOOOOOOOOO0OOO0OOOO0O</code>에서 일부를 <code>copy_array_range</code>로 잘라서 <code>call_fn_*</code>을 하는 경우에 deobfuscate 를 함부로 할 수가 없다. </p>
<p>하지만 다행히도 <code>copy_array_range</code>는 <code>./code</code>에서 아예 사용이 되지 않았고, <code>call_fn_*</code>는 <code>522739 : O0O0OOO00OO00O00O(call_fn_arg1) len flag</code>에서만 사용되었기 때문에 안심하고 0OO00OO0O0… 들을 deobfuscate 할 수 있다. 그러고 나니 다음과 같이 코드가 충분히 가독성 있게 바뀌었다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// disassemble + deobfuscate instruction name + deobfuscate instruction arguments</span><br><span class="line">0 : store_int v1854_ 215232</span><br><span class="line">89 : store_int v1353_ 1934246</span><br><span class="line">193 : store_int v1639_ 3907144</span><br><span class="line">289 : xor_int v523_ v1353_ v1639_</span><br><span class="line">588 : add_obj v1750_ v1854_ v523_</span><br><span class="line">870 : store_int v3158_ 30984</span><br><span class="line">922 : store_int v3120_ 7126</span><br><span class="line">974 : store_int v2160_ 22475</span><br><span class="line">1054 : add_obj v2867_ v3120_ v2160_</span><br><span class="line">1225 : store_int v407_ 33325</span><br><span class="line">1353 : xor_int v3491_ v2867_ v407_</span><br><span class="line">1562 : xor_int v406_ v3158_ v3491_</span><br><span class="line">1763 : store_int v3087_ 38229</span><br><span class="line">1817 : store_int v3337_ 19486</span><br><span class="line">1864 : xor_int v2124_ v3087_ v3337_</span><br><span class="line">2024 : add_obj v2001_ v406_ v2124_</span><br><span class="line">2295 : store_int v2365_ 5452</span><br><span class="line">2368 : store_int v2592_ 13</span><br><span class="line">2433 : store_int v2824_ 86</span><br><span class="line">2491 : xor_int v3376_ v2592_ v2824_</span><br><span class="line">2644 : store_int v2292_ 812</span><br><span class="line">...</span><br><span class="line">(총 4000줄 정도)</span><br></pre></td></tr></table></figure>
<p>4000 줄을 일일히 확인할 수는 없기에, 우리가 <code>f20</code>에 input 으로 넣어주는 <code>flag</code>가 어디서 사용되는지 확인해보았다.</p>
<ul>
<li>522739 : call_fn_arg1 len flag </li>
<li>530636 : copy_array_nth_elem v5_ flag v23_ </li>
<li>543477 : copy_array_nth_elem v5_ flag v22_ </li>
<li>550293 : copy_array_nth_elem v5_ flag v21_ </li>
<li>559834 : copy_array_nth_elem v5_ flag v20_ </li>
<li>561532 : copy_array_nth_elem v5_ flag v19_ </li>
<li>563001 : copy_array_nth_elem v5_ flag v18_ </li>
<li>566791 : copy_array_nth_elem v5_ flag v17_ </li>
<li>570233 : copy_array_nth_elem v5_ flag v16_ </li>
</ul>
<p><code>call_fn_arg1 len flag</code>를 통해 flag 의 길이를 알아내고, 그 후에 <code>copy_array_nth_elem</code>을 통해 flag 의 내용을 갖고와서 작업을 하는 것 같았다.</p>
<p>이 중, <code>call_fn_arg1 len flag</code>에서 가장 먼저 flag 가 사용된다고 가정하고 그 근처의 루틴을 살펴보자.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; 522739 : call_fn_arg1 len flag</span><br><span class="line">522750 : store_int v3093_ 2061660835264941322</span><br><span class="line">&gt;&gt; 522817 : get_retvalue v7_</span><br><span class="line">522965 : store_int v2012_ 1931060806939442519</span><br><span class="line">523062 : store_int v188_ 1912105736640534932</span><br><span class="line">523209 : store_int v691_ 1403666796827268127</span><br><span class="line">523342 : jmp_e 00523824 v188_ v691_</span><br><span class="line">523589 : store_int v3049_ 454244320653564008</span><br><span class="line">523656 : xor_int v3092_ v2012_ v3049_</span><br><span class="line">523824 : store_int v2200_ 17672463509507717380</span><br><span class="line">523917 : store_int v1248_ 11343481858817674308</span><br><span class="line">524036 : jmp_e 00522750 v2200_ v1248_</span><br><span class="line">524213 : store_int v987_ 9660428932043588362</span><br><span class="line">524338 : store_int v3131_ 13420171158865409813</span><br><span class="line">524405 : store_int v1061_ 11837173573825369995</span><br><span class="line">524529 : store_int v3130_ 12661355576187245068</span><br><span class="line">524596 : store_int v2405_ 6550099183382177835</span><br><span class="line">524682 : jmp_e 00525350 v1061_ v2405_</span><br><span class="line">524858 : store_int v986_ 4035472596024876566</span><br><span class="line">524983 : store_int v596_ 17948315935351036473</span><br><span class="line">525120 : jmp_e 00525350 v3131_ v986_</span><br><span class="line">525278 : store_int v2898_ 6982746897035690610</span><br><span class="line">525350 : store_int v2519_ 17798970078863431467</span><br><span class="line">525434 : store_int v795_ 17754493080910117873</span><br><span class="line">525565 : jmp_e 00527440 v2519_ v795_</span><br><span class="line">525745 : add_obj v2331_ v3092_ v2898_</span><br><span class="line">525908 : store_int v2869_ 2546325066566470140</span><br><span class="line">&gt;&gt; 525981 : jmp_e 00529928 v7_ v15_</span><br></pre></td></tr></table></figure>
<p>뭔가 복잡해 보이지만, 위의 28개의 instruction 중에서 실제로 의미가 있는 instruction 은 &gt;&gt; 표시한 3개 뿐이다. </p>
<p>참고로, 나머지를 살펴보면</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">523062 : store_int v188_ 1912105736640534932</span><br><span class="line">523209 : store_int v691_ 1403666796827268127</span><br><span class="line">523342 : jmp_e 00523824 v188_ v691_ // if (1912... == 1403...) jmp 523824</span><br></pre></td></tr></table></figure>
<p>와 같이 아무 의미도 없는 instruction 들이었다.</p>
<blockquote>
<p>이 루틴 뿐만 아니라, 전체적으로도 이와 완전히 같은 형태로 무의미한 instruction 들을 잔뜩 넣어놓은 것을 확인할 수 있었고, 이들을 머릿속에서 필터링하면서 보면, 실제로 분석해야 하는 부분은 100줄도 안된다는 것을 알 수 있다!</p>
</blockquote>
<p>다시 본론으로 돌아오면, <code>len(flag) == v15_</code>이면 다른 루틴으로 들어가는데, 찾아보니 <code>v15_</code>는 <code>461139 : store_int v15_ 8</code>에서 8로 정의가 되어있었다. 즉, flag 를 입력할 때 8글자인 경우와 아닌 경우에 behavior 가 완전히 다르다는 것이다.</p>
<p>이를 자세히 알아보기 위해 <code>play.py</code>의 f20 함수에서 instruction 을 decode 할 때마다 (Program Counter, Instruction name) 의 조합을 logging 하는 식으로 기초적인 동적 디버깅을 해보았다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># play.py (with debugging stuffs)</span></span><br><span class="line">debug = <span class="keyword">True</span></span><br><span class="line">log = []</span><br><span class="line">...</span><br><span class="line"><span class="comment"># f20(code, flag)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">O0O0O0O00OO0O0O0O</span><span class="params">(OOO0OO0O000O0OOOO ,OOO0O0000OOOO0OO0)</span>:</span></span><br><span class="line">    O0O0O0000OO0OOO0O=dict() <span class="comment"># table</span></span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">	<span class="comment"># for debug</span></span><br><span class="line">    log.append(OOO0O0000OOOO0OO0) <span class="comment"># [our input flag]</span></span><br><span class="line">    flag_ba = bytearray(<span class="string">"flag"</span>, encoding=<span class="string">"utf-8"</span>)</span><br><span class="line">    <span class="keyword">while</span> OOO000O0O0OOO0OOO==<span class="number">0</span>:</span><br><span class="line">        O00OOO00000OO0OOO=O0O0O0000OO0OOO0O[OOOO0000OOO0OOO0O]</span><br><span class="line">        OO0OO0OOOOO00OO00=OOO0OO0O000O0OOOO[O00OOO00000OO0OOO]</span><br><span class="line">        log.append((O00OOO00000OO0OOO, op_table[OO0OO0OOOOO00OO00]))</span><br><span class="line">        <span class="comment"># log.append((pc, opcode)), op_table from disassembler.py</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="comment"># if oparg_len &gt; 0</span></span><br><span class="line">        <span class="keyword">if</span> O000OOO00OOO0O00O&lt;OO000O0OOOOOOO0OO:</span><br><span class="line">            ...</span><br><span class="line">            table_2001 = O0O0O0000OO0OOO0O[O00OOO0O00OOOOO0O]</span><br><span class="line">            <span class="keyword">if</span> table_2001 == flag_ba:</span><br><span class="line">                log.append(<span class="string">"flag here"</span>)</span><br><span class="line">            O00OOO00000OO0OOO=O00OOO00000OO0OOO+O0OOOO00O0OOO00OO</span><br><span class="line">        <span class="comment"># if oparg_len &gt; 1</span></span><br><span class="line">        <span class="keyword">if</span> OOO0OO0OO0OOO00O0&lt;OO000O0OOOOOOO0OO:</span><br><span class="line">            ...</span><br><span class="line">            table_2002 = O0O0O0000OO0OOO0O[OO0OO00000000O00O]</span><br><span class="line">            <span class="keyword">if</span> table_2002 == flag_ba:</span><br><span class="line">                log.append(<span class="string">"flag here"</span>)</span><br><span class="line">            O00OOO00000OO0OOO=O00OOO00000OO0OOO+OO000O00OO0O0O0O0</span><br><span class="line">        <span class="comment"># if oparg_len &gt; 2</span></span><br><span class="line">        <span class="keyword">if</span> O0OOOOOOOOO00OOOO&lt;OO000O0OOOOOOO0OO:</span><br><span class="line">            ...</span><br><span class="line">            table_2003 = O0O0O0000OO0OOO0O[O0OO0OO0000O0O0OO]</span><br><span class="line">            <span class="keyword">if</span> table_2003 == flag_ba:</span><br><span class="line">                log.append(<span class="string">"flag here"</span>)</span><br><span class="line">            O00OOO00000OO0OOO=O00OOO00000OO0OOO+O0OOO0OOOOO0OOO0O</span><br><span class="line">        <span class="comment"># if oparg_len &gt; 3</span></span><br><span class="line">        <span class="keyword">if</span> OO0O0O0000000O00O&lt;OO000O0OOOOOOO0OO:</span><br><span class="line">            ...</span><br><span class="line">            table_2004 = O0O0O0000OO0OOO0O[O0O000OOO0OOOO0OO]</span><br><span class="line">            <span class="keyword">if</span> table_2004 == flag_ba:</span><br><span class="line">                log.append(<span class="string">"flag here"</span>)</span><br><span class="line">            O00OOO00000OO0OOO=O00OOO00000OO0OOO+O00O00000OOOO00O0</span><br><span class="line">        O0O0O0000OO0OOO0O[OOOO0000OOO0OOO0O]=O00OOO00000OO0OOO</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        print(<span class="string">'\n'</span>.join(map(str, log)))</span><br><span class="line">	<span class="keyword">return</span> O00OO000OO0O0O0O0 <span class="comment"># return value table[1001]</span></span><br></pre></td></tr></table></figure>
<h4 id="a-len-flag-8-일-때-gt-flag-를-본격적으로-읽어오는-일-없이-fail"><a href="#a-len-flag-8-일-때-gt-flag-를-본격적으로-읽어오는-일-없이-fail" class="headerlink" title="a) len(flag) != 8 일 때 =&gt; flag 를 본격적으로 읽어오는 일 없이 fail"></a>a) len(flag) != 8 일 때 =&gt; flag 를 본격적으로 읽어오는 일 없이 fail</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">bytearray(b&apos;asdf&apos;) # flag = &quot;asdf&quot;</span><br><span class="line">...</span><br><span class="line">(522739, b&apos;call_fn_arg1&apos;) # table[1001] = len(flag)</span><br><span class="line">flag here</span><br><span class="line">(522750, b&apos;store_int&apos;)</span><br><span class="line">(522817, b&apos;get_retvalue&apos;)</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">(526975, b&apos;store_int&apos;)</span><br><span class="line">(527035, b&apos;store_int&apos;)</span><br><span class="line">(527104, b&apos;store_int&apos;)</span><br><span class="line">(527240, b&apos;add_obj&apos;)</span><br><span class="line">(527440, b&apos;set_retvalue&apos;)</span><br><span class="line">:(</span><br></pre></td></tr></table></figure>
<h4 id="b-len-flag-8-일-때-gt-len-flag-와-8번의-copy-array-nth-elem-가-모두-사용"><a href="#b-len-flag-8-일-때-gt-len-flag-와-8번의-copy-array-nth-elem-가-모두-사용" class="headerlink" title="b) len(flag) == 8 일 때 =&gt; len(flag) 와 8번의 copy_array_nth_elem 가 모두 사용"></a>b) len(flag) == 8 일 때 =&gt; len(flag) 와 8번의 copy_array_nth_elem 가 모두 사용</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">bytearray(b&apos;asdfzxcv&apos;) # flag= &quot;asdfzxcv&quot;</span><br><span class="line">...</span><br><span class="line">(522739, b&apos;call_fn_arg1&apos;)</span><br><span class="line">flag here</span><br><span class="line">(522750, b&apos;store_int&apos;)</span><br><span class="line">...</span><br><span class="line">(530636, b&apos;copy_array_nth_elem&apos;)</span><br><span class="line">flag here</span><br><span class="line">(530935, b&apos;store_int&apos;)</span><br><span class="line">...</span><br><span class="line">(543477, b&apos;copy_array_nth_elem&apos;)</span><br><span class="line">flag here</span><br><span class="line">(543776, b&apos;store_int&apos;)</span><br><span class="line">...</span><br><span class="line"># 추가로 6번의 copy_array_nth_elem</span><br><span class="line">...</span><br><span class="line">(604602, b&apos;set_retvalue&apos;)</span><br><span class="line">:(</span><br></pre></td></tr></table></figure>
<p>이렇게 올바른 flag 의 길이는 8 이어야 한다는 것을 알 수 있다. 그럼 이제 <code>copy_array_nth_elem ... flag ...</code>의 근처 루틴을 보고 flag 가 어떻게 쓰이는 지를 확인해보자.</p>
<h3 id="Conclusion-Actual-routine-of-code-binary-where-user-input-is-used"><a href="#Conclusion-Actual-routine-of-code-binary-where-user-input-is-used" class="headerlink" title="Conclusion : Actual routine of ./code binary where user input is used"></a>Conclusion : Actual routine of ./code binary where user input is used</h3><p><code>v24_, v8_</code>등 알아내기 힘든 값은 <code>play.py</code>의 <code>xor_int, lshift_int, and_int, jmp_ne</code>에서 log 를 찍어서 동적으로 알아낼 수 있다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"># 의미 없는 &quot;if 1==2 jmp somewhere&quot; 걸러내고, 모르는 변수들은 동적 디버깅으로 확인한 결과 (괄호 안에 적힌 값 : 동적 디버깅으로 확인한 값)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">515818 : store_int v1607_ 0</span><br><span class="line">515908 : store_int v2977_ 15611366610146654427</span><br><span class="line">515979 : store_int v2768_ 0</span><br><span class="line">516037 : store_int v2085_ 440204574901743917</span><br><span class="line">516131 : store_int v879_ 407685722495890841</span><br><span class="line">516258 : jmp_e 00515818 v2085_ v879_</span><br><span class="line">516448 : add_obj v9_ v1607_ (0) v2768_ (0) # v9_ 초기화</span><br><span class="line"></span><br><span class="line">530636 : copy_array_nth_elem v5_ flag v23_ (v23_ == 0) # v5_ = flag[0]</span><br><span class="line">...</span><br><span class="line">537237 : add_obj v9_ v9_ v5_ </span><br><span class="line"># v9_ += v5_ (== flag[0])</span><br><span class="line"></span><br><span class="line">540596 : lshift_int v9_ v9_ v15_ (0)</span><br><span class="line"># v9_ &lt;&lt;= 8</span><br><span class="line"></span><br><span class="line"># v9_ += flag[1]</span><br><span class="line"># v9_ &lt;&lt;= 8</span><br><span class="line"></span><br><span class="line"># v9_ += flag[2]</span><br><span class="line"># v9_ &lt;&lt;= 8</span><br><span class="line"></span><br><span class="line"># v9_ += flag[3]</span><br><span class="line"># v9_ &lt;&lt;= 8</span><br><span class="line"></span><br><span class="line"># v9_ += flag[4]</span><br><span class="line"># v9_ &lt;&lt;= 8</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">v9_ += flag[7] </span><br><span class="line"># (v9 = flag[0] || flag[1] || ... || flag[7] (|| 는 concat, 하나 당 1byte))</span><br><span class="line"></span><br><span class="line">loop:</span><br><span class="line">573096 : store_int v3089_ 12708581081101316949</span><br><span class="line">573164 : store_int v2690_ 1377021718065100325</span><br><span class="line">573242 : store_int v875_ 387529906359523825</span><br><span class="line">573369 : jmp_e 00575597 v2690_ v875_</span><br><span class="line">573542 : jmp_ge 00596781 v4_ (0에서 시작) v12_ (127) </span><br><span class="line"># v4_가 i 같은 것이고, v12_와 같아지면 596781로 jump</span><br><span class="line"># 그리고 v4_는 596088 에서만 1씩 증가</span><br><span class="line"></span><br><span class="line">574498 : rshift_int v3_ v9_ v14_ (32)</span><br><span class="line">v3_ = v9_ &gt;&gt; 32 (4byte) (v3_ = flag[0] || flag[1] || flag[2] || flag[3])</span><br><span class="line"></span><br><span class="line">575157 : xor_int v3_ v3_ v24_ (4290952684)</span><br><span class="line">576876 : add_obj v3_ v3_ v24_ (4290952684)</span><br><span class="line">578096 : and_int v3_ v3_ v11_ (4294967295)</span><br><span class="line">579286 : and_int v2_ v9_ v11_ (4294967295)</span><br><span class="line">579726 : xor_int v2_ v2_ v24_ (4290952684)</span><br><span class="line">580431 : add_obj v2_ v2_ v24_ (4290952684)</span><br><span class="line">581086 : and_int v2_ v2_ v11_ (4294967295)</span><br><span class="line">582380 : move v9_ v2_</span><br><span class="line">585784 : lshift_int v9_ v9_ 32</span><br><span class="line">586625 : or_int v9_ v9_ v3_</span><br><span class="line"></span><br><span class="line">588130 : store_int v1_ 127</span><br><span class="line">588282 : and_int v0_ v9_ v1_ (127)</span><br><span class="line">588722 : rshift_int v9_ v9_ v16_ (7)</span><br><span class="line"></span><br><span class="line">593440 : lshift_int v0_ v0_ v13_ (57) </span><br><span class="line">594250 : or_int v9_ v9_ v0_</span><br><span class="line">595498 : and_int v9_ v9_ v10_ (18446744073709551615) </span><br><span class="line"></span><br><span class="line">596088 : add_obj v4_ v4_ v22_ (1)</span><br><span class="line">596528 : store_int v1787_ 1045426129032952985</span><br><span class="line">596631 : jmp 00573096 (loop)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">596642 : store_int v494_ 5667802367195705777</span><br><span class="line">596781 : jmp_ne 00598799 v9_ v8_ (15164928151071436234) &lt; 여기서 v8_ 하고 v9_ 하고 같으면 597084이 실행됨.</span><br><span class="line"></span><br><span class="line">597084 : store_int v6_ 1 &lt; 여기에 들어서면 성공. v6_가 f20의 return value 가 됨.</span><br></pre></td></tr></table></figure>
<p>위의 루틴을 python 으로 다시 정리해보자.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">flag = <span class="string">"abcdefgh"</span></span><br><span class="line">v9 = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> flag:</span><br><span class="line">    v9 += ord(c)</span><br><span class="line">    v9 &lt;&lt;= <span class="number">8</span></span><br><span class="line">v9 &gt;&gt;= <span class="number">8</span></span><br><span class="line"><span class="comment"># v9_ = 0x6162636465666768</span></span><br><span class="line"></span><br><span class="line">v24 = <span class="number">4290952684</span> <span class="comment"># 0b11111111110000101011110111101100 (32bit)</span></span><br><span class="line">v11 = <span class="number">4294967295</span> <span class="comment"># 0b11111111111111111111111111111111 (32bit)</span></span><br><span class="line">v10 = <span class="number">18446744073709551615</span></span><br><span class="line"><span class="comment"># 0b1111111111111111111111111111111111111111111111111111111111111111 (64bit)</span></span><br><span class="line"></span><br><span class="line">v4 = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> v4 &lt; <span class="number">127</span>:</span><br><span class="line">    v3 = v9 &gt;&gt; <span class="number">32</span> <span class="comment"># v3 : upper 32bit of v9</span></span><br><span class="line"></span><br><span class="line">    v24 = <span class="number">4290952684</span> <span class="comment"># 0b11111111110000101011110111101100 (32bit)</span></span><br><span class="line">    v11 = <span class="number">4294967295</span> <span class="comment"># 0b11111111111111111111111111111111 (32bit)</span></span><br><span class="line"></span><br><span class="line">    v3 = v3 ^ v24 </span><br><span class="line">    v3 = v3 + v24</span><br><span class="line">    v3 = v3 &amp; v11 <span class="comment"># (adjust to 32bit)</span></span><br><span class="line">    <span class="comment"># v3 = (upper 32bit of v9) ^ v24 + v24</span></span><br><span class="line">    </span><br><span class="line">    v9 = v9 &amp; v11 <span class="comment"># (adjust to 32bit) =&gt; v9 = lower 32bit of v9</span></span><br><span class="line">    v9 = v9 ^ v24 </span><br><span class="line">    v9 = v9 + v24</span><br><span class="line">    v9 = v9 &amp; v11 <span class="comment"># (adjust to 32bit)</span></span><br><span class="line">    <span class="comment"># v9 = (lower 32bit of v9) ^ v24 + v24</span></span><br><span class="line">    </span><br><span class="line">    v9 = v9 &lt;&lt; <span class="number">32</span></span><br><span class="line">    v9 = v9 | v3</span><br><span class="line">    <span class="comment"># v9 = swap_lower_32_upper_32((original v9) ^ v24 + v24)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># rotating 7bit to right</span></span><br><span class="line">    v0 = v9 &amp; <span class="number">127</span> <span class="comment"># v0 : v9 &amp; 0b01111111 (lower 7bit)</span></span><br><span class="line">    v9 = v9 &gt;&gt; <span class="number">7</span></span><br><span class="line">    v0 = v0 &lt;&lt; <span class="number">57</span> <span class="comment"># v0 : v9 의 lower 7bit 가 상위 7bit가 됨</span></span><br><span class="line">    v9 = v9 | v0</span><br><span class="line"></span><br><span class="line">    <span class="comment"># no-op</span></span><br><span class="line">    v9 = v9 &amp; v10</span><br><span class="line"></span><br><span class="line">    v4 = v4 + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">v8 = <span class="number">15164928151071436234</span></span><br><span class="line"><span class="comment"># v9 should be same with v8</span></span><br></pre></td></tr></table></figure>
<p>다행히도 역함수가 깔끔하게 존재하는 루틴임을 알 수 있다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># solve.py</span></span><br><span class="line"></span><br><span class="line">v24 = <span class="number">4290952684</span> <span class="comment"># 0b11111111110000101011110111101100 (32bit)</span></span><br><span class="line">v11 = <span class="number">4294967295</span> <span class="comment"># 0b11111111111111111111111111111111 (32bit)</span></span><br><span class="line">v10 = <span class="number">18446744073709551615</span></span><br><span class="line"><span class="comment"># 0b1111111111111111111111111111111111111111111111111111111111111111 (64bit)</span></span><br><span class="line"></span><br><span class="line">v4 = <span class="number">127</span></span><br><span class="line">v8 = <span class="number">15164928151071436234</span></span><br><span class="line"><span class="keyword">while</span> v4 &gt; <span class="number">0</span>:</span><br><span class="line">    v4 -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># rotating 7bit to left</span></span><br><span class="line">    v0 = v8 &gt;&gt; <span class="number">57</span> <span class="comment"># v0 : upper 7bit of v8</span></span><br><span class="line">    v8 = v8 &lt;&lt; <span class="number">7</span></span><br><span class="line">    v8 = v8 | v0</span><br><span class="line">    v8 = v8 &amp; v10 <span class="comment"># (adjust to 64bit)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># split v8 into upper_32bit and lower_32bit</span></span><br><span class="line">    <span class="comment"># subtract v24, xor v24 with each 32bit chunks</span></span><br><span class="line">    <span class="comment"># (only thing to consider is emulating underflow when subtracting!)</span></span><br><span class="line">    </span><br><span class="line">    v8_upper = v8 &gt;&gt; <span class="number">32</span></span><br><span class="line">    <span class="keyword">if</span> v8_upper &gt; v11:</span><br><span class="line">        print(<span class="string">"v8_upper &gt; v11 ! your code is wrong"</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    v8_lower = v8 &amp; v11</span><br><span class="line"></span><br><span class="line">    tmp = v11 + <span class="number">1</span> <span class="comment"># 0b10000....0 (33bit)</span></span><br><span class="line">    <span class="keyword">if</span> v8_upper &lt; v24:</span><br><span class="line">        v8_upper += tmp</span><br><span class="line">    v8_upper -= v24</span><br><span class="line">    v8_upper ^= v24</span><br><span class="line">    <span class="keyword">if</span> v8_lower &lt; v24:</span><br><span class="line">        v8_lower += tmp</span><br><span class="line">    v8_lower -= v24</span><br><span class="line">    v8_lower ^= v24</span><br><span class="line"></span><br><span class="line">    <span class="comment"># new v8 = calc result of lower_32bit || calc result of upper_32bit</span></span><br><span class="line">    v8 = v8_lower &lt;&lt; <span class="number">32</span></span><br><span class="line">    v8 = v8 | v8_upper</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> hex(v8)[<span class="number">2</span>:<span class="number">-1</span>].decode(<span class="string">'hex'</span>)</span><br></pre></td></tr></table></figure>
<p><strong>Flag : d34dPY27</strong></p>
<p>- written by metamon</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="../../../../index.html">Home</a></li>
         
          <li><a href="../../../../about/">About</a></li>
         
          <li><a href="../../../../archives/">Writing</a></li>
         
          <li><a href="../../../../categories/">categories</a></li>
         
          <li><a href="../../../../tags/">tags</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Codegate-Qual-Writeup-mic-check-20000-PyProt3ct-with-KAIST-GoN"><span class="toc-number">1.</span> <span class="toc-text">Codegate Qual Writeup (mic check, 20000, PyProt3ct) with KAIST GoN</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-MIC-check"><span class="toc-number">1.1.</span> <span class="toc-text">1. MIC check</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-20000"><span class="toc-number">1.2.</span> <span class="toc-text">2. 20000</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-PyProt3ct"><span class="toc-number">1.3.</span> <span class="toc-text">3. PyProt3ct</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Deobfuscate-of-play-py"><span class="toc-number">1.3.1.</span> <span class="toc-text">1) Deobfuscate of play.py</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Analyze-VM-code-play-py"><span class="toc-number">1.3.2.</span> <span class="toc-text">2) Analyze VM code (play.py)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#instruction-format"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">instruction format</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#memory-structure"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">memory structure</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#instructions-thanks-to-ironore-for-help"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">instructions (thanks to ironore for help)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Disassemble-custom-binary-code-and-analyze-it-by-pruning-unnecessary-routines-and-dynamic-debugging"><span class="toc-number">1.3.3.</span> <span class="toc-text">3) Disassemble custom binary (./code) and analyze it by pruning unnecessary routines and dynamic debugging</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#a-len-flag-8-일-때-gt-flag-를-본격적으로-읽어오는-일-없이-fail"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">a) len(flag) != 8 일 때 =&gt; flag 를 본격적으로 읽어오는 일 없이 fail</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#b-len-flag-8-일-때-gt-len-flag-와-8번의-copy-array-nth-elem-가-모두-사용"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">b) len(flag) == 8 일 때 =&gt; len(flag) 와 8번의 copy_array_nth_elem 가 모두 사용</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Conclusion-Actual-routine-of-code-binary-where-user-input-is-used"><span class="toc-number">1.3.4.</span> <span class="toc-text">Conclusion : Actual routine of ./code binary where user input is used</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/01/31/codegate-2019-qual-writeup/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/01/31/codegate-2019-qual-writeup/&text=codegate-2019-qual-writeup"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/01/31/codegate-2019-qual-writeup/&title=codegate-2019-qual-writeup"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/01/31/codegate-2019-qual-writeup/&is_video=false&description=codegate-2019-qual-writeup"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=codegate-2019-qual-writeup&body=Check out this article: http://yoursite.com/2019/01/31/codegate-2019-qual-writeup/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/01/31/codegate-2019-qual-writeup/&title=codegate-2019-qual-writeup"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/01/31/codegate-2019-qual-writeup/&title=codegate-2019-qual-writeup"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/01/31/codegate-2019-qual-writeup/&title=codegate-2019-qual-writeup"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/01/31/codegate-2019-qual-writeup/&title=codegate-2019-qual-writeup"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/01/31/codegate-2019-qual-writeup/&name=codegate-2019-qual-writeup&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 Dongpyeong Seo
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="../../../../index.html">Home</a></li>
         
          <li><a href="../../../../about/">About</a></li>
         
          <li><a href="../../../../archives/">Writing</a></li>
         
          <li><a href="../../../../categories/">categories</a></li>
         
          <li><a href="../../../../tags/">tags</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="../../../../lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="../../../../lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="../../../../lib/jquery/jquery.min.js"></script>
<script src="../../../../lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="../../../../js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'metamon';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


